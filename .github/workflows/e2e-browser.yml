name: E2E Browser Spec

run-name: "E2E: browser-rendered esports spec"

on:
  workflow_dispatch:

jobs:
  resolve-browser-spec:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Install Chromium dependencies
        run: npx puppeteer browsers install chrome

      - name: "Resolve: lpl-wbg-vs-blg-game1-week1-2026 (browser)"
        run: |
          npx tsx src/cli/run-resolver.ts specs/lpl-wbg-vs-blg-game1-week1-2026.json > /tmp/result.json

      - name: Verify result
        run: |
          echo "=== Signed Payload ==="
          cat /tmp/result.json
          echo ""

          PARSED_VALUE=$(node -e "console.log(JSON.parse(require('fs').readFileSync('/tmp/result.json','utf8')).parsedValue)")
          RESULT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('/tmp/result.json','utf8')).result)")

          echo "parsedValue: $PARSED_VALUE"
          echo "result: $RESULT"

          if [ "$PARSED_VALUE" != "1" ]; then
            echo "FAIL: expected parsedValue=1 (Weibo win), got $PARSED_VALUE"
            exit 1
          fi

          if [ "$RESULT" != "true" ]; then
            echo "FAIL: expected result=true, got $RESULT"
            exit 1
          fi

          echo "PASS: browser spec resolved correctly"

      - uses: actions/upload-artifact@v4
        with:
          name: signed-payload-esports-e2e
          path: |
            /tmp/result.json
            /tmp/voran-browser-screenshot.png
          retention-days: 7
