name: Generate Spec

run-name: "Generate: ${{ inputs.title || inputs.prompt }}"

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Natural language market description (e.g. 'Will BTC exceed $120k by March 2026?')"
        required: true
        type: string
      title:
        description: "Short run title (e.g. 'BTC > $120k'). Defaults to full prompt if empty."
        required: false
        type: string
      model:
        description: "LLM provider/model (e.g. openai/gpt-4o, anthropic/claude-sonnet-4-20250514). Leave empty to auto-detect."
        required: false
        type: string
      max_steps:
        description: "Maximum agent steps"
        required: false
        default: "15"
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Install Chromium
        run: npx puppeteer browsers install chrome

      - name: Generate spec
        timeout-minutes: 7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        run: |
          ARGS=("${{ inputs.prompt }}" --dry-run --verbose --max-steps "${{ inputs.max_steps }}" --output /tmp/spec.json)
          if [ -n "${{ inputs.model }}" ]; then
            ARGS+=(--model "${{ inputs.model }}")
          fi
          npx tsx src/cli/generate-spec.ts "${ARGS[@]}"

      - name: Show generated spec
        run: |
          echo "=== Generated Spec ==="
          cat /tmp/spec.json

      - name: Create PR with spec
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          MARKET_ID=$(node -e "console.log(JSON.parse(require('fs').readFileSync('/tmp/spec.json','utf8')).marketId)")
          SPEC_FILE="specs/${MARKET_ID}.json"
          BRANCH="spec/${MARKET_ID}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          cp /tmp/spec.json "$SPEC_FILE"
          git add "$SPEC_FILE"
          git commit -m "Add spec: ${MARKET_ID}"
          git push origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "Add spec: ${MARKET_ID}" \
            --body "$(cat <<EOF
          ## Generated Resolution Spec

          **Prompt:** ${{ inputs.prompt }}
          **Model:** ${{ inputs.model || 'auto-detected' }}
          **Max steps:** ${{ inputs.max_steps }}

          \`\`\`json
          $(cat /tmp/spec.json)
          \`\`\`

          Generated by [Generate Spec](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow â€” see the action logs for full LLM reasoning.
          EOF
          )")

          echo "PR created: $PR_URL"

      - uses: actions/upload-artifact@v4
        with:
          name: generated-spec
          path: /tmp/spec.json
          retention-days: 30
